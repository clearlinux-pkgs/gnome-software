From b689990a3a47856580819c318bfe1c4df21ff182 Mon Sep 17 00:00:00 2001
From: Josue David Hernandez Gutierrez <josue.d.hernandez.gutierrez@intel.com>
Date: Wed, 24 Jul 2019 15:40:01 -0500
Subject: [PATCH] make the json url for swupd configurable

Signed-off-by: Josue David Hernandez Gutierrez <josue.d.hernandez.gutierrez@intel.com>
---
 plugins/swupd/gs-plugin-swupd.c | 42 ++++++++++++++++++++++++++++++---
 1 file changed, 39 insertions(+), 3 deletions(-)

diff --git a/plugins/swupd/gs-plugin-swupd.c b/plugins/swupd/gs-plugin-swupd.c
index f86e4bc4..a63d8432 100644
--- a/plugins/swupd/gs-plugin-swupd.c
+++ b/plugins/swupd/gs-plugin-swupd.c
@@ -37,6 +37,7 @@
 #define GS_PLUGIN_SWUPD_BUNDLES_ICON_PATH "/usr/share/clear/bundle-icons"
 #define GS_PLUGIN_SWUPD_BUNDLES_DEFAULT_ICON_PATH GS_PLUGIN_SWUPD_BUNDLES_ICON_PATH"/bundle.svg"
 #define GS_PLUGIN_SWUPD_BUNDLES_SCREENSHOT_PATH "/usr/share/clear/bundle-screenshots"
+#define GS_PLUGIN_SWUPD_SOURCEURL_FILE "/usr/share/clear/sourceurl.ini"
 
 struct GsPluginData {
 	GPtrArray *bundles;
@@ -260,9 +261,44 @@ gs_plugin_swupd_get_apps (GsPlugin *plugin, GPtrArray *bundles)
 	gint i;
 	g_autoptr (JsonParser) json_parser = NULL;
 
-	uri = g_strdup_printf ("%s/%s/assets/bundles/bundles.json",
-			       GS_PLUGIN_SWUPD_DATA_URL,
-			       priv->clr_version);
+	if (g_file_test (GS_PLUGIN_SWUPD_SOURCEURL_FILE, G_FILE_TEST_EXISTS | G_FILE_TEST_IS_REGULAR)) {
+		g_autoptr(GError) error = NULL;
+		g_autoptr(GKeyFile) key_file = g_key_file_new ();
+		g_autofree gchar *base_url = NULL;
+		g_autofree gchar *json_path = NULL;
+
+		if (!g_key_file_load_from_file (key_file, GS_PLUGIN_SWUPD_SOURCEURL_FILE, G_KEY_FILE_NONE, &error)) {
+			g_debug ("error: %s sourceurl file not found: %s", error->message);
+			return;
+		}
+
+		base_url = g_key_file_get_string (key_file, "Default", "BASE_URL", &error);
+		if (base_url == NULL) {
+			g_debug ("error finding BASE_URL in the key file: %s", error->message);
+			return;
+		}
+
+		json_path = g_key_file_get_string (key_file, "Default", "JSON_PATH", &error);
+		if (json_path == NULL) {
+			g_debug ("error finding JSON_PATH in the key file: %sn", error->message);
+			return;
+		}
+
+		uri = g_strdup_printf ("%s/%s/%s",
+				       base_url,
+				       priv->clr_version,
+				       json_path);
+	} else {
+		uri = g_strdup_printf ("%s/%s/assets/bundles/bundles.json",
+				       GS_PLUGIN_SWUPD_DATA_URL,
+				       priv->clr_version);
+	}
+
+	if (!g_str_has_prefix (uri, "http")) {
+		g_debug ("error wrong url format: %s", uri);
+		return;
+	}
+
 	gs_app_set_summary_missing (app_dl, "Downloading bundles metadata");
 	data = gs_plugin_download_data (plugin, app_dl, uri, NULL, &err);
 	if (data == NULL) {
-- 
2.22.0

